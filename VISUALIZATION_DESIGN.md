# LLMsKnow Layer Visualization Tool - Design Document

## Overview

An interactive, explorative visualization tool for understanding how LLMs process information through their layers, with focus on:
- **Token generation process**: How each output token is "created" across layers
- **Correctness detection**: When/where the model "knows" it's right or wrong
- **Model-agnostic**: Works with any supported model (Mistral, LLaMA, etc.)

---

## Supported Models

The tool automatically adapts to any model in the codebase:

| Model | Layers | Hidden Size |
|-------|--------|-------------|
| Mistral-7B-Instruct-v0.2 | 32 | 4096 |
| Mistral-7B-v0.3 | 32 | 4096 |
| Meta-Llama-3-8B | 32 | 8192 |
| Meta-Llama-3-8B-Instruct | 32 | 8192 |

Adding new models requires only updating `probing_utils.py` - the visualization adapts automatically.

---

## UI Layout

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ§  LLMsKnow Layer Explorer                    [Model: Mistral-7B â–¼]        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  INPUT                                                               â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚   â”‚
â”‚  â”‚  â”‚ Who directed the movie Titanic?                            [â–¶]  â”‚â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  OUTPUT                                                              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚   â”‚
â”‚  â”‚  â”‚ [James]  [Cameron]  [directed]  [Titanic]  [.]                  â”‚â”‚   â”‚
â”‚  â”‚  â”‚    â†‘         â†‘                                                  â”‚â”‚   â”‚
â”‚  â”‚  â”‚  click tokens to explore their generation process               â”‚â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  LAYER FLOW (Left â†’ Right = Layer Depth)                                   â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚                                                                             â”‚
â”‚   L0        L4        L8        L12       L16       L20       L24      L31  â”‚
â”‚   â”Œâ”€â”       â”Œâ”€â”       â”Œâ”€â”       â”Œâ”€â”       â”Œâ”€â”       â”Œâ”€â”       â”Œâ”€â”      â”Œâ”€â”  â”‚
â”‚   â”‚ â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚â–‘â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚â–’â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚â–“â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚â–“â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚â–ˆâ”‚â”€â”€â”€â”€â”€â”€â–¶â”‚â–ˆâ”‚â”€â”€â”€â”€â”€â–¶â”‚â–ˆâ”‚  â”‚
â”‚   â””â”€â”˜       â””â”€â”˜       â””â”€â”˜       â””â”€â”˜       â””â”€â”˜       â””â”€â”˜       â””â”€â”˜      â””â”€â”˜  â”‚
â”‚    â”‚         â”‚         â”‚         â”‚         â”‚         â”‚         â”‚        â”‚   â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚   ğŸ”´ 0.12   ğŸ”´ 0.23   ğŸŸ¡ 0.45   ğŸŸ¡ 0.58   ğŸŸ¢ 0.72   ğŸŸ¢ 0.85   ğŸŸ¢ 0.91  ğŸŸ¢ 0.96â”‚
â”‚                                                                             â”‚
â”‚   CORRECTNESS CONFIDENCE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚   â”‚â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”‚  â”‚
â”‚   0.0                          0.5                                    1.0   â”‚
â”‚   Wrong â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Correct     â”‚
â”‚                                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  INSIGHT PANEL                                                              â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ“ Selected: Layer 16, Token "Cameron"                             â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚   â”‚
â”‚  â”‚  â”‚ Activation Stats â”‚  â”‚ Top Attention Heads                      â”‚â”‚   â”‚
â”‚  â”‚  â”‚                  â”‚  â”‚                                          â”‚â”‚   â”‚
â”‚  â”‚  â”‚ Mean: 0.342      â”‚  â”‚ Head 12.3: 0.89 â†’ "director"            â”‚â”‚   â”‚
â”‚  â”‚  â”‚ Std:  0.156      â”‚  â”‚ Head 8.7:  0.76 â†’ "Titanic"             â”‚â”‚   â”‚
â”‚  â”‚  â”‚ Max:  2.341      â”‚  â”‚ Head 15.2: 0.71 â†’ "movie"               â”‚â”‚   â”‚
â”‚  â”‚  â”‚ Min: -1.892      â”‚  â”‚                                          â”‚â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚   â”‚
â”‚  â”‚  â”‚ Probe Prediction History                                       â”‚â”‚   â”‚
â”‚  â”‚  â”‚                                                                â”‚â”‚   â”‚
â”‚  â”‚  â”‚ Confidence â–²                                    â–ˆâ–ˆâ–ˆâ–ˆ           â”‚â”‚   â”‚
â”‚  â”‚  â”‚           â”‚                              â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ           â”‚â”‚   â”‚
â”‚  â”‚  â”‚           â”‚                        â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ           â”‚â”‚   â”‚
â”‚  â”‚  â”‚           â”‚                  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ           â”‚â”‚   â”‚
â”‚  â”‚  â”‚           â”‚            â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ         â”‚â”‚   â”‚
â”‚  â”‚  â”‚           â”‚      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ       â”‚â”‚   â”‚
â”‚  â”‚  â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶      â”‚â”‚   â”‚
â”‚  â”‚  â”‚             L0   L4   L8   L12  L16  L20  L24  L28  L31       â”‚â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Visual Elements

### 1. Layer Nodes
```
   Normal          Hovered         Selected        Correct         Wrong
   â”Œâ”€â”€â”€â”           â”Œâ”€â”€â”€â”           â”â”â”â”â”“           â”Œâ”€â”€â”€â”           â”Œâ”€â”€â”€â”
   â”‚ â–‘ â”‚           â”‚â–’â–’â–’â”‚           â”ƒâ–ˆâ–ˆâ–ˆâ”ƒ           â”‚ğŸŸ¢ â”‚           â”‚ğŸ”´ â”‚
   â””â”€â”€â”€â”˜           â””â”€â”€â”€â”˜           â”—â”â”â”â”›           â””â”€â”€â”€â”˜           â””â”€â”€â”€â”˜
   
   Color intensity = activation magnitude
   Border = selection state
   Inner icon = correctness prediction
```

### 2. Connection Lines
```
   Thin (low weight)          Medium                    Thick (high weight)
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•          â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
   
   Color gradient from source to target layer
   Opacity = confidence/importance
```

### 3. Token Chips (Output)
```
   Unselected              Selected                 Correct              Wrong
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”â”â”â”â”â”â”â”â”â”â”“             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Cameron â”‚            â”ƒ Cameron â”ƒ             â”‚âœ“Cameron â”‚          â”‚âœ— wrong  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”—â”â”â”â”â”â”â”â”â”â”›             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   gray bg                 blue border             green tint           red tint
```

### 4. Correctness Gradient Bar
```
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   ğŸ”´ 0.0            ğŸŸ¡ 0.5                                    ğŸŸ¢ 1.0
   
   Smooth gradient: Red â†’ Yellow â†’ Green
   Marker shows current layer's prediction
```

---

## Interaction Flows

### Flow 1: Run New Question
```
User types question â†’ Clicks [â–¶] Run
                           â†“
              Backend loads model (if needed)
                           â†“
              Generate answer token by token
                           â†“
              Extract layer representations
                           â†“
              Run probe at each layer
                           â†“
              Return all data to frontend
                           â†“
              Animate layer flow visualization
                           â†“
              Display tokens with correctness colors
```

### Flow 2: Explore Token Generation
```
User clicks output token (e.g., "Cameron")
                           â†“
              Highlight token's "path" through layers
                           â†“
              Show attention connections for this token
                           â†“
              Update insight panel with:
                - Activation statistics
                - Top contributing attention heads
                - Layer-by-layer probe predictions
```

### Flow 3: Explore Layer
```
User clicks layer node (e.g., Layer 16)
                           â†“
              Highlight layer
                           â†“
              Show all tokens at this layer position
                           â†“
              Update insight panel with:
                - Layer-wide statistics
                - Probe prediction at this layer
                - Comparison to previous/next layers
```

### Flow 4: Switch Model
```
User selects different model from dropdown
                           â†“
              Clear current visualization
                           â†“
              Load new model (show loading indicator)
                           â†“
              Adapt UI to new layer count
                           â†“
              Ready for new question
```

---

## Data Flow Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              FRONTEND (React + D3)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ Input       â”‚    â”‚ Layer       â”‚    â”‚ Token       â”‚    â”‚ Insight    â”‚  â”‚
â”‚   â”‚ Component   â”‚â”€â”€â”€â–¶â”‚ Visualizer  â”‚â—€â”€â”€â–¶â”‚ Display     â”‚â”€â”€â”€â–¶â”‚ Panel      â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚          â”‚                  â–²                  â–²                  â–²         â”‚
â”‚          â”‚                  â”‚                  â”‚                  â”‚         â”‚
â”‚          â–¼                  â”‚                  â”‚                  â”‚         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚   â”‚                        State Management                                 â”‚
â”‚   â”‚   â€¢ currentModel       â€¢ selectedToken                                 â”‚
â”‚   â”‚   â€¢ question/answer    â€¢ selectedLayer                                 â”‚
â”‚   â”‚   â€¢ layerData[]        â€¢ insightData                                   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                      â”‚                                      â”‚
â”‚                                      â–¼                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                              API CLIENT                                     â”‚
â”‚                         WebSocket / REST API                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           BACKEND (FastAPI + Python)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                       â”‚
â”‚   â”‚ /api/models     â”‚ â†’ List available models                              â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                                       â”‚
â”‚   â”‚ /api/generate   â”‚ â†’ Run model, return answer + layer data              â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                                       â”‚
â”‚   â”‚ /api/probe      â”‚ â†’ Get probe predictions for all layers               â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                                       â”‚
â”‚   â”‚ /api/layer/{n}  â”‚ â†’ Get detailed data for specific layer               â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                       â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                        Model Manager                                 â”‚   â”‚
â”‚   â”‚   â€¢ load_model(name)      - Load model into memory                  â”‚   â”‚
â”‚   â”‚   â€¢ generate(prompt)      - Generate + extract representations      â”‚   â”‚
â”‚   â”‚   â€¢ get_probe_preds()     - Run probe classifier at each layer      â”‚   â”‚
â”‚   â”‚   â€¢ get_layer_data(n)     - Get activations for layer n             â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                      â”‚                                      â”‚
â”‚                                      â–¼                                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                    Existing Codebase Integration                     â”‚   â”‚
â”‚   â”‚                                                                      â”‚   â”‚
â”‚   â”‚   probing_utils.py  â†’  load_model_and_validate_gpu()                â”‚   â”‚
â”‚   â”‚                    â†’  extract_internal_reps_*()                     â”‚   â”‚
â”‚   â”‚   probe.py         â†’  trained probe classifiers                     â”‚   â”‚
â”‚   â”‚   compute_*.py     â†’  correctness calculation                       â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Structures

### LayerData (per layer)
```json
{
  "layer_idx": 16,
  "layer_name": "model.layers.16.mlp",
  "activations": {
    "mean": 0.342,
    "std": 0.156,
    "max": 2.341,
    "min": -1.892
  },
  "probe_prediction": {
    "confidence": 0.72,
    "prediction": "correct",
    "probabilities": [0.28, 0.72]
  },
  "top_neurons": [
    {"idx": 1542, "activation": 2.341},
    {"idx": 892, "activation": 2.156}
  ]
}
```

### TokenData (per output token)
```json
{
  "token_idx": 0,
  "token_text": "James",
  "token_id": 5765,
  "is_correct": true,
  "generation_probability": 0.89,
  "layer_journey": [
    {"layer": 0, "activation_norm": 0.12},
    {"layer": 8, "activation_norm": 0.34},
    {"layer": 16, "activation_norm": 0.67},
    {"layer": 31, "activation_norm": 0.95}
  ]
}
```

### SessionData (per question)
```json
{
  "session_id": "abc123",
  "model": "mistralai/Mistral-7B-Instruct-v0.2",
  "question": "Who directed Titanic?",
  "answer": "James Cameron",
  "tokens": [TokenData, ...],
  "layers": [LayerData, ...],
  "overall_correctness": 0.96,
  "ground_truth": "James Cameron",
  "is_correct": true
}
```

---

## Color Scheme

### Primary Palette
```
Background:       #FAFAFA (light gray)
Card Background:  #FFFFFF (white)
Text Primary:     #1A1A1A (near black)
Text Secondary:   #666666 (gray)
Border:           #E0E0E0 (light gray)
```

### Semantic Colors
```
Correct (high):   #22C55E (green)
Correct (mid):    #84CC16 (lime)
Neutral:          #EAB308 (yellow)
Wrong (mid):      #F97316 (orange)
Wrong (high):     #EF4444 (red)
```

### Gradient for Correctness
```css
background: linear-gradient(
  to right,
  #EF4444 0%,      /* red */
  #F97316 25%,     /* orange */
  #EAB308 50%,     /* yellow */
  #84CC16 75%,     /* lime */
  #22C55E 100%     /* green */
);
```

### Layer Node Colors (by activation intensity)
```
Low activation:   #E5E7EB (gray-200)
Medium:           #93C5FD (blue-300)
High:             #3B82F6 (blue-500)
Very high:        #1D4ED8 (blue-700)
```

---

## File Structure

```
visualization/
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ app.py              # FastAPI application
â”‚   â”œâ”€â”€ model_manager.py    # Model loading & inference
â”‚   â”œâ”€â”€ layer_extractor.py  # Layer representation extraction
â”‚   â””â”€â”€ probe_runner.py     # Probe predictions
â”‚
â”œâ”€â”€ frontend/
â”‚   â”œâ”€â”€ public/
â”‚   â”‚   â””â”€â”€ index.html
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ App.tsx
â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â”œâ”€â”€ InputPanel.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ LayerFlow.tsx        # D3 visualization
â”‚   â”‚   â”‚   â”œâ”€â”€ TokenDisplay.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ InsightPanel.tsx
â”‚   â”‚   â”‚   â””â”€â”€ CorrectnessBar.tsx
â”‚   â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”‚   â””â”€â”€ useLayerData.ts
â”‚   â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”‚   â””â”€â”€ client.ts
â”‚   â”‚   â””â”€â”€ styles/
â”‚   â”‚       â””â”€â”€ globals.css
â”‚   â”œâ”€â”€ package.json
â”‚   â””â”€â”€ tsconfig.json
â”‚
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ run.py                  # Single command to start both
â””â”€â”€ README.md
```

---

## Implementation Phases

### Phase 1: Core Backend (2-3 hours)
- [ ] FastAPI server setup
- [ ] Model loading endpoint
- [ ] Generation + layer extraction endpoint
- [ ] Probe prediction endpoint
- [ ] Integration with existing `probing_utils.py`

### Phase 2: Basic Frontend (3-4 hours)
- [ ] React app scaffold
- [ ] Input component (question box, model selector)
- [ ] Token display (clickable output tokens)
- [ ] Basic layer flow (static boxes, no D3 yet)
- [ ] API integration

### Phase 3: D3 Visualization (4-5 hours)
- [ ] Layer node visualization with D3
- [ ] Connection lines with weight-based thickness
- [ ] Correctness gradient bar
- [ ] Animations (layer flow, selection)
- [ ] Responsive layout

### Phase 4: Insight Panel (2-3 hours)
- [ ] Layer detail view
- [ ] Token journey visualization
- [ ] Activation statistics display
- [ ] Probe prediction history chart

### Phase 5: Polish (2 hours)
- [ ] Loading states
- [ ] Error handling
- [ ] Keyboard shortcuts
- [ ] Mobile responsiveness
- [ ] Documentation

---

## Usage

### Start the visualization tool:
```bash
cd visualization
python run.py
```

This will:
1. Start the FastAPI backend on `http://localhost:8000`
2. Start the React frontend on `http://localhost:3000`
3. Open your browser automatically

### First run:
1. Select a model from the dropdown
2. Wait for model to load (first time may take ~30s)
3. Enter a question and click Run
4. Explore the visualization!

---

## Future Enhancements

- [ ] **Comparison mode**: Side-by-side view of two different questions
- [ ] **Batch mode**: Visualize patterns across multiple questions
- [ ] **Export**: Save visualizations as images/PDFs
- [ ] **Attention heads**: Visualize attention patterns
- [ ] **Neuron search**: Find neurons that activate for specific concepts
- [ ] **Training mode**: See how probe accuracy changes with more training data
